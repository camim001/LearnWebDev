<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Glucose Tracker</title>
    <style>
        :root {
            font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial;
        }

        body {
            margin: 0;
            padding: 16px;
            background: #f7f8fa;
            color: #0b1220
        }

        .container {
            max-width: 900px;
            margin: 0 auto
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            box-shadow: 0 6px 18px rgba(12,20,30,0.06)
        }

        form {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 8px
        }

        label {
            font-size: 12px;
            color: #444
        }

        input, textarea, select {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e2e6ef;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box
        }

        textarea {
            grid-column: span 4;
            min-height: 56px
        }

        .btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 0;
            background: #2563eb;
            color: #fff;
            font-weight: 600;
            cursor: pointer
        }

            .btn.ghost {
                background: #eef2ff;
                color: #1e3a8a
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }

        th, td {
            padding: 8px;
            border-bottom: 1px solid #f1f3f9;
            text-align: left;
            font-size: 14px
        }

        .muted {
            color: #6b7280;
            font-size: 13px
        }

        @media(max-width:720px) {
            form {
                grid-template-columns: repeat(2,1fr)
            }

            textarea {
                grid-column: span 2
            }
        }
    </style>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Glucose Tracker</h1>
            <div class="controls">
                <button id="signinBtn" class="btn">Sign in (Google)</button>
                <button id="signoutBtn" class="btn ghost" style="display:none">Sign out</button>
                <button id="exportCsv" class="btn ghost">Export CSV</button>
            </div>
        </header>

        <div class="card">
            <form id="entryForm">
                <div>
                    <label for="date">Date</label>
                    <input id="date" type="date" required />
                </div>
                <div>
                    <label for="time">Time</label>
                    <input id="time" type="time" required />
                </div>
                <div>
                    <label for="glucose">Glucose (mmol/L)</label>
                    <input id="glucose" type="number" step="0.1" min="0" required />
                </div>
                <div>
                    <label for="note">Comment (optional)</label>
                    <input id="note" type="text" placeholder="e.g., before breakfast" />
                </div>
                <textarea id="comment" placeholder="Extra notes (optional)"></textarea>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button type="submit" class="btn">Add entry</button>
                </div>
            </form>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Entries</strong>
                <div class="muted">Autosaves to your Google Drive (app-created file)</div>
            </div>
            <div id="status" class="muted" style="margin-top:8px">Not signed in</div>
            <table id="entriesTable">
                <thead><tr><th>Date</th><th>Time</th><th>Glucose (mmol/L)</th><th>Comment</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card muted" style="text-align:center;margin-top:12px;font-size:13px">
            Hosted at: https://camim001.github.io/GlucoseTracker/
        </div>
    </div>

    <script>
        // ----------------------------
        // Configuration (user-provided)
        // ----------------------------
        const CLIENT_ID = '74449140663-d7ufgeqonjvmph6dliijgrv2mf0n5jc3.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file'; // app can create and manage files it created
        const FILE_NAME = 'GlucoseTracker_data.json';
        const APP_PROPERTY_KEY = 'app';
        const APP_PROPERTY_VAL = 'GlucoseTracker';

        // ----------------------------
        // App state
        // ----------------------------
        let tokenClient;
        let accessToken = null;
        let fileId = null;
        let entries = []; // array of {date,time,glucose,comment,createdAt}

        // Elements
        const signinBtn = document.getElementById('signinBtn');
        const signoutBtn = document.getElementById('signoutBtn');
        const statusEl = document.getElementById('status');
        const entryForm = document.getElementById('entryForm');
        const entriesTableBody = document.querySelector('#entriesTable tbody');
        const exportCsvBtn = document.getElementById('exportCsv');

        // Initialize Google Identity token client
        function initGSI() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) {
                        console.error('Token error', resp);
                        statusEl.textContent = 'Sign-in failed';
                        return;
                    }
                    accessToken = resp.access_token;
                    google.accounts.oauth2.disableAutoSelect();
                    onSignedIn();
                }
            });
        }

        function updateStatus() {
            if (accessToken) {
                statusEl.textContent = 'Signed in — ' + (fileId ? 'syncing with Drive' : 'no data file yet');
                signinBtn.style.display = 'none';
                signoutBtn.style.display = 'inline-block';
            } else {
                statusEl.textContent = 'Not signed in';
                signinBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
            }
        }

        // Sign-in / out
        signinBtn.addEventListener('click', () => {
            // request access token (will popup)
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });

        signoutBtn.addEventListener('click', () => {
            if (accessToken) {
                // revoke token
                fetch('https://oauth2.googleapis.com/revoke?token=' + accessToken, { method: 'POST', headers: { 'Content-type': 'application/x-www-form-urlencoded' } })
                    .finally(() => {
                        accessToken = null; fileId = null; entries = []; renderEntries(); updateStatus();
                    });
            }
        });

        // After signed in
        async function onSignedIn() {
            updateStatus();
            // find or create data file
            try {
                const found = await findDataFile();
                if (found) {
                    fileId = found.id;
                    await loadDataFile();
                } else {
                    await createDataFile();
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = 'Error accessing Drive: ' + err.message;
            }
            updateStatus();
        }

        // Search Drive for file with our appProperties
        async function findDataFile() {
            const q = `name='${FILE_NAME.replace(/'/g, "\\'")}' and trashed=false and appProperties has { key='${APP_PROPERTY_KEY}' and value='${APP_PROPERTY_VAL}' }`;
            const url = 'https://www.googleapis.com/drive/v3/files?fields=files(id,name)&q=' + encodeURIComponent(q);
            const res = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken } });
            if (!res.ok) throw new Error('Drive search failed: ' + res.statusText);
            const data = await res.json();
            return (data.files && data.files.length > 0) ? data.files[0] : null;
        }

        // Create initial file
        async function createDataFile() {
            const metadata = { name: FILE_NAME, mimeType: 'application/json', appProperties: { [APP_PROPERTY_KEY]: APP_PROPERTY_VAL } };
            const initial = JSON.stringify([]);
            // multipart upload
            const boundary = '-------314159265358979323846';
            const delimiter = '\r\n--' + boundary + '\r\n';
            const close_delim = '\r\n--' + boundary + '--';
            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                initial +
                close_delim;

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                body: multipartRequestBody
            });
            if (!res.ok) throw new Error('Drive file create failed: ' + (await res.text()));
            const data = await res.json();
            fileId = data.id;
            entries = [];
            renderEntries();
        }

        // Load file content
        async function loadDataFile() {
            const url = 'https://www.googleapis.com/drive/v3/files/' + fileId + '?alt=media';
            const res = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken } });
            if (!res.ok) throw new Error('Failed to read file: ' + res.statusText);
            const text = await res.text();
            try {
                const parsed = JSON.parse(text || '[]');
                entries = Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.warn('Could not parse file, resetting.');
                entries = [];
            }
            renderEntries();
        }

        // Save (overwrite) file content
        async function saveDataFile() {
            if (!fileId) throw new Error('No file id');
            const url = 'https://www.googleapis.com/upload/drive/v3/files/' + fileId + '?uploadType=media';
            const body = JSON.stringify(entries);
            const res = await fetch(url, { method: 'PATCH', headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' }, body });
            if (!res.ok) throw new Error('Failed to save file: ' + await res.text());
        }

        // UI actions
        entryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const glucose = parseFloat(document.getElementById('glucose').value);
            const note = document.getElementById('note').value || '';
            const comment = document.getElementById('comment').value || '';
            if (!date || !time || isNaN(glucose)) return alert('Please fill date/time/glucose');
            const entry = { date, time, glucose, note, comment, createdAt: new Date().toISOString() };
            entries.unshift(entry); // newest first
            renderEntries();
            // autosave: if signed in -> save to Drive; otherwise save to localStorage
            try {
                if (accessToken && fileId) {
                    await saveDataFile();
                    statusEl.textContent = 'Saved to Drive';
                } else {
                    localStorage.setItem('glucose_local_backup', JSON.stringify(entries));
                    statusEl.textContent = 'Saved locally (not signed in)';
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = 'Save failed: ' + err.message;
            }
            entryForm.reset();
        });

        function renderEntries() {
            entriesTableBody.innerHTML = '';
            for (let i = 0; i < entries.length; i++) {
                const e = entries[i];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(e.date)}</td><td>${escapeHtml(e.time)}</td><td>${escapeHtml(String(e.glucose))}</td><td>${escapeHtml(e.note || e.comment || '')}</td><td><button data-idx="${i}" class="btn ghost small">Delete</button></td>`;
                entriesTableBody.appendChild(tr);
            }
            // attach delete handlers
            Array.from(entriesTableBody.querySelectorAll('button[data-idx]')).forEach(btn => {
                btn.addEventListener('click', async () => {
                    const idx = Number(btn.getAttribute('data-idx'));
                    if (!confirm('Delete this entry?')) return;
                    entries.splice(idx, 1);
                    renderEntries();
                    try {
                        if (accessToken && fileId) await saveDataFile(); else localStorage.setItem('glucose_local_backup', JSON.stringify(entries));
                    } catch (err) { console.error(err); statusEl.textContent = 'Save failed: ' + err.message }
                });
            });
        }

        function escapeHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        // Export CSV
        exportCsvBtn.addEventListener('click', () => {
            const rows = [['date', 'time', 'glucose_mmol_L', 'note', 'comment', 'createdAt']];
            for (const r of entries) rows.push([r.date, r.time, r.glucose, r.note || '', r.comment || '', r.createdAt || '']);
            const csv = rows.map(r => r.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'glucose_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });

        // On load: init GSI and restore local backup if any
        window.addEventListener('load', () => {
            initGSI();
            const backup = localStorage.getItem('glucose_local_backup');
            if (backup) {
                try { const parsed = JSON.parse(backup); if (Array.isArray(parsed) && parsed.length > 0) { entries = parsed; renderEntries(); statusEl.textContent = 'Loaded local backup (not signed in)'; } } catch (e) { }
            }
            updateStatus();
        });

    </script>
</body>
</html>
